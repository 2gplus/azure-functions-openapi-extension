parameters:
  configuration: ''
  version: ''

steps:
- task: DotNetCoreCLI@2
  displayName: '.NET Pack'
  inputs:
    command: custom
    custom: 'pack'
    projects: |
      # ./src/Microsoft.Azure.WebJobs.Extensions.OpenApi.AppSettings/Microsoft.Azure.WebJobs.Extensions.OpenApi.AppSettings.csproj
      # ./src/Microsoft.Azure.WebJobs.Extensions.OpenApi.Core/Microsoft.Azure.WebJobs.Extensions.OpenApi.Core.csproj
      ./src/Microsoft.Azure.WebJobs.Extensions.OpenApi.Core.Extensions/Microsoft.Azure.WebJobs.Extensions.OpenApi.Core.Extensions.csproj
      # ./src/Microsoft.Azure.WebJobs.Extensions.OpenApi/Microsoft.Azure.WebJobs.Extensions.OpenApi.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.Core.Extensions/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.Core.Extensions.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Admin/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Admin.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Anonymous/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Anonymous.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Function/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.Function.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.System/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.System.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.User/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OAuth2Redirect.User.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Admin/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Admin.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Anonymous/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Anonymous.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Function/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.Function.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.System/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.System.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.User/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.OpenApiDocument.User.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Admin/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Admin.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Anonymous/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Anonymous.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Function/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.Function.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.System/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.System.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.User/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerDocument.User.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Admin/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Admin.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Anonymous/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Anonymous.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Function/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.Function.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.System/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.System.csproj
      ./src/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.User/Microsoft.Azure.Functions.Worker.Extensions.OpenApi.SwaggerUI.User.csproj
    arguments: '-c ${{ parameters.configuration }} -o $(Build.ArtifactStagingDirectory) --no-build --include-symbols /p:PackageVersion=${{ parameters.version }} -v Quiet'

- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
  displayName: 'ESRP CodeSigning: Nupkg'
  condition: and(succeeded(), eq(variables['SignArtifacts'], 'true'))
  inputs:
    ConnectedServiceName: 'ESRP Service'
    FolderPath: '$(Build.ArtifactStagingDirectory)'
    Pattern: '*.nupkg'
    signConfigType: inlineSignParams
    inlineOperation: |
     [
         {
           "KeyCode": "CP-401405",
           "OperationCode": "NuGetSign",
           "Parameters": {},
           "ToolName": "sign",
           "ToolVersion": "1.0"
         },
         {
           "KeyCode": "CP-401405",
           "OperationCode": "NuGetVerify",
           "Parameters": {},
           "ToolName": "sign",
           "ToolVersion": "1.0"
         }
     ]

- task: PowerShell@2
  displayName: 'Delete CodeSignSummary Files'
  condition: and(succeeded(), eq(variables['SignArtifacts'], 'true'))
  inputs:
    targetType: Inline
    script: |
      Get-ChildItem -Path $(Build.ArtifactStagingDirectory) -Include CodeSignSummary-*.md -Recurse | Remove-Item -Force

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifacts'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: drop
    publishLocation: Container
